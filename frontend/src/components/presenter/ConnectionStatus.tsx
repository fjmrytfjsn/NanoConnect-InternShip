/**
 * Êé•Á∂öÁä∂ÊÖãË°®Á§∫„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
 * Socket.IOÊé•Á∂öÁä∂ÊÖã„ÄÅ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÂìÅË≥™„ÄÅÊé•Á∂öÁµ±Ë®à„ÇíË°®Á§∫
 */

import React, { useState, useCallback } from 'react';
import {
  Box,
  Card,
  CardContent,
  Typography,
  Chip,
  LinearProgress,
  IconButton,
  Tooltip,
  Alert,
  Collapse,
  Divider,
  Grid,
} from '@mui/material';
import {
  WifiOff,
  SignalCellular0Bar,
  SignalCellular1Bar,
  SignalCellular3Bar,
  SignalCellular4Bar,
  Refresh,
  ExpandMore,
  ExpandLess,
  Speed,
  Replay,
} from '@mui/icons-material';
import { useRealtimeConnection } from '@/hooks/useRealtimeConnection';
import { useSelector } from 'react-redux';
import { socketSelectors } from '@/store/slices/socketSlice';

/**
 * ConnectionStatus„Éó„É≠„Éë„ÉÜ„Ç£
 */
export interface ConnectionStatusProps {
  compact?: boolean;
  showDetails?: boolean;
  showStats?: boolean;
  onReconnect?: () => void;
  className?: string;
}

/**
 * Êé•Á∂öÁä∂ÊÖãË°®Á§∫„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
 */
export const ConnectionStatus: React.FC<ConnectionStatusProps> = ({
  compact = false,
  showDetails = true,
  showStats = true,
  onReconnect,
  className,
}) => {
  // „Éï„ÉÉ„ÇØ„Åã„ÇâÊé•Á∂öÁä∂ÊÖã„ÇíÂèñÂæó
  const {
    connectionState,
    isConnected,
    isConnecting,
    networkState,
    connectionQuality,
    reconnectAttempts,
    stats,
    forceReconnect,
    pingServer,
  } = useRealtimeConnection({
    autoConnect: true,
    enableQualityMonitoring: true,
    enableNetworkStateMonitoring: true,
  });

  // ReduxÁä∂ÊÖã„Åã„ÇâËøΩÂä†ÊÉÖÂ†±„ÇíÂèñÂæó
  const error = useSelector(socketSelectors.getError);
  const settings = useSelector(socketSelectors.getSettings);

  // „É≠„Éº„Ç´„É´Áä∂ÊÖã
  const [showExpandedStats, setShowExpandedStats] = useState(false);
  const [isPinging, setIsPinging] = useState(false);

  // ========== „Éè„É≥„Éâ„É©„Éº ==========

  const handleReconnect = useCallback(async () => {
    try {
      await forceReconnect();
      onReconnect?.();
    } catch (error) {
      console.error('ÂÜçÊé•Á∂ö„Ç®„É©„Éº:', error);
    }
  }, [forceReconnect, onReconnect]);

  const handlePing = useCallback(async () => {
    if (isPinging) return;

    setIsPinging(true);
    try {
      const latency = await pingServer();
      console.log(`üìä Ping: ${latency}ms`);
    } catch (error) {
      console.error('Ping„Ç®„É©„Éº:', error);
    } finally {
      setIsPinging(false);
    }
  }, [isPinging, pingServer]);

  const toggleExpandedStats = () => {
    setShowExpandedStats(!showExpandedStats);
  };

  // ========== Ë°®Á§∫Áî®„Éá„Éº„ÇøË®àÁÆó ==========

  const getConnectionIcon = () => {
    if (networkState === 'offline') {
      return <WifiOff color="error" />;
    }

    if (!isConnected) {
      return <WifiOff color="disabled" />;
    }

    switch (connectionQuality) {
      case 'excellent':
        return <SignalCellular4Bar color="success" />;
      case 'good':
        return <SignalCellular3Bar color="primary" />;
      case 'poor':
        return <SignalCellular1Bar color="warning" />;
      default:
        return <SignalCellular0Bar color="disabled" />;
    }
  };

  const getConnectionColor = () => {
    if (networkState === 'offline' || !isConnected) {
      return 'error';
    }

    switch (connectionQuality) {
      case 'excellent':
        return 'success';
      case 'good':
        return 'primary';
      case 'poor':
        return 'warning';
      default:
        return 'default';
    }
  };

  const getConnectionText = () => {
    if (networkState === 'offline') {
      return '„Ç™„Éï„É©„Ç§„É≥';
    }

    if (isConnecting) {
      return 'Êé•Á∂ö‰∏≠...';
    }

    if (!isConnected) {
      return 'Êú™Êé•Á∂ö';
    }

    switch (connectionQuality) {
      case 'excellent':
        return 'ÂÑ™ÁßÄ';
      case 'good':
        return 'ËâØÂ•Ω';
      case 'poor':
        return '‰∏çÂÆâÂÆö';
      default:
        return 'Êé•Á∂öÊ∏à„Åø';
    }
  };

  const formatTime = (ms: number) => {
    if (ms < 1000) return `${ms}ms`;
    if (ms < 60000) return `${Math.round(ms / 1000)}Áßí`;
    return `${Math.round(ms / 60000)}ÂàÜ`;
  };

  // ========== „Ç≥„É≥„Éë„ÇØ„Éà„É¢„Éº„Éâ ==========
  if (compact) {
    return (
      <Box
        className={className}
        sx={{ display: 'flex', alignItems: 'center', gap: 1 }}
      >
        <Tooltip title={`Êé•Á∂öÁä∂ÊÖã: ${getConnectionText()}`}>
          <Box sx={{ display: 'flex', alignItems: 'center' }}>
            {getConnectionIcon()}
          </Box>
        </Tooltip>

        <Chip
          label={getConnectionText()}
          color={getConnectionColor()}
          size="small"
          variant="outlined"
        />

        {reconnectAttempts > 0 && (
          <Tooltip title={`ÂÜçÊé•Á∂öË©¶Ë°å: ${reconnectAttempts}Âõû`}>
            <Chip
              label={reconnectAttempts}
              color="warning"
              size="small"
              icon={<Replay />}
            />
          </Tooltip>
        )}

        {(!isConnected || error.hasError) && (
          <Tooltip title="ÂÜçÊé•Á∂ö">
            <IconButton size="small" onClick={handleReconnect}>
              <Refresh fontSize="small" />
            </IconButton>
          </Tooltip>
        )}
      </Box>
    );
  }

  // ========== ÈÄöÂ∏∏„É¢„Éº„Éâ ==========
  return (
    <Card className={className}>
      <CardContent>
        {/* „Éò„ÉÉ„ÉÄ„Éº */}
        <Box
          sx={{
            display: 'flex',
            justifyContent: 'space-between',
            alignItems: 'center',
            mb: 2,
          }}
        >
          <Typography variant="h6">Êé•Á∂öÁä∂ÊÖã</Typography>
          <Box sx={{ display: 'flex', gap: 1 }}>
            <Tooltip title="Êé•Á∂ö„ÉÜ„Çπ„Éà">
              <IconButton
                size="small"
                onClick={handlePing}
                disabled={!isConnected || isPinging}
              >
                <Speed />
              </IconButton>
            </Tooltip>
            <Tooltip title="ÂÜçÊé•Á∂ö">
              <IconButton size="small" onClick={handleReconnect}>
                <Refresh />
              </IconButton>
            </Tooltip>
          </Box>
        </Box>

        {/* „É°„Ç§„É≥Êé•Á∂öÁä∂ÊÖã */}
        <Box sx={{ display: 'flex', alignItems: 'center', mb: 3 }}>
          <Box sx={{ mr: 2, fontSize: '2rem' }}>{getConnectionIcon()}</Box>
          <Box sx={{ flexGrow: 1 }}>
            <Typography variant="h6">{getConnectionText()}</Typography>
            <Typography variant="body2" color="text.secondary">
              {connectionState}{' '}
              {networkState === 'offline' && '(„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÂúèÂ§ñ)'}
            </Typography>
            {isConnecting && <LinearProgress sx={{ mt: 1 }} />}
          </Box>
          <Chip
            label={isConnected ? '„Ç™„É≥„É©„Ç§„É≥' : '„Ç™„Éï„É©„Ç§„É≥'}
            color={getConnectionColor()}
            variant="filled"
          />
        </Box>

        {/* „Ç®„É©„ÉºË°®Á§∫ */}
        {error.hasError && (
          <Alert severity="error" sx={{ mb: 2 }}>
            <Typography variant="body2" component="div">
              {error.message}
              {error.code && (
                <Typography variant="caption" display="block" sx={{ mt: 0.5 }}>
                  „Ç®„É©„Éº„Ç≥„Éº„Éâ: {error.code}
                </Typography>
              )}
            </Typography>
          </Alert>
        )}

        {/* ÂÜçÊé•Á∂öÊÉÖÂ†± */}
        {reconnectAttempts > 0 && (
          <Alert severity="info" sx={{ mb: 2 }}>
            ÂÜçÊé•Á∂ö„Çí {reconnectAttempts} ÂõûË©¶Ë°å‰∏≠
            {settings.maxReconnectAttempts && (
              <span>
                {' '}
                ({reconnectAttempts}/{settings.maxReconnectAttempts})
              </span>
            )}
          </Alert>
        )}

        {/* Êé•Á∂öÂìÅË≥™Ë©≥Á¥∞ */}
        {showDetails && isConnected && (
          <Box sx={{ mb: 2 }}>
            <Typography variant="subtitle2" gutterBottom>
              Êé•Á∂öÂìÅË≥™
            </Typography>
            <Grid container spacing={2}>
              {stats.lastLatency && (
                <Grid item xs={6}>
                  <Box sx={{ textAlign: 'center' }}>
                    <Typography variant="h6" color="primary">
                      {Math.round(stats.lastLatency)}ms
                    </Typography>
                    <Typography variant="caption" color="text.secondary">
                      „É¨„Ç§„ÉÜ„É≥„Ç∑
                    </Typography>
                  </Box>
                </Grid>
              )}
              {stats.averageLatency && (
                <Grid item xs={6}>
                  <Box sx={{ textAlign: 'center' }}>
                    <Typography variant="h6" color="text.secondary">
                      {Math.round(stats.averageLatency)}ms
                    </Typography>
                    <Typography variant="caption" color="text.secondary">
                      Âπ≥Âùá„É¨„Ç§„ÉÜ„É≥„Ç∑
                    </Typography>
                  </Box>
                </Grid>
              )}
            </Grid>
          </Box>
        )}

        {/* Áµ±Ë®àÊÉÖÂ†± */}
        {showStats && (
          <Box>
            <Box
              sx={{
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
                mb: 1,
              }}
            >
              <Typography variant="subtitle2">Êé•Á∂öÁµ±Ë®à</Typography>
              <IconButton size="small" onClick={toggleExpandedStats}>
                {showExpandedStats ? <ExpandLess /> : <ExpandMore />}
              </IconButton>
            </Box>

            <Grid container spacing={1}>
              <Grid item xs={4}>
                <Box sx={{ textAlign: 'center' }}>
                  <Typography variant="body2" sx={{ fontWeight: 'medium' }}>
                    {stats.reconnectCount}
                  </Typography>
                  <Typography variant="caption" color="text.secondary">
                    ÂÜçÊé•Á∂öÂõûÊï∞
                  </Typography>
                </Box>
              </Grid>
              <Grid item xs={4}>
                <Box sx={{ textAlign: 'center' }}>
                  <Typography variant="body2" sx={{ fontWeight: 'medium' }}>
                    {formatTime(stats.connectedTime)}
                  </Typography>
                  <Typography variant="caption" color="text.secondary">
                    Êé•Á∂öÊôÇÈñì
                  </Typography>
                </Box>
              </Grid>
              <Grid item xs={4}>
                <Box sx={{ textAlign: 'center' }}>
                  <Typography variant="body2" sx={{ fontWeight: 'medium' }}>
                    {formatTime(stats.disconnectedTime)}
                  </Typography>
                  <Typography variant="caption" color="text.secondary">
                    ÂàáÊñ≠ÊôÇÈñì
                  </Typography>
                </Box>
              </Grid>
            </Grid>

            <Collapse in={showExpandedStats}>
              <Divider sx={{ my: 2 }} />
              <Grid container spacing={2}>
                <Grid item xs={6}>
                  <Typography variant="body2" color="text.secondary">
                    Ëá™ÂãïÂÜçÊé•Á∂ö:
                  </Typography>
                  <Typography variant="body2">
                    {settings.autoReconnect ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ'}
                  </Typography>
                </Grid>
                <Grid item xs={6}>
                  <Typography variant="body2" color="text.secondary">
                    ÊúÄÂ§ßË©¶Ë°åÂõûÊï∞:
                  </Typography>
                  <Typography variant="body2">
                    {settings.maxReconnectAttempts}Âõû
                  </Typography>
                </Grid>
              </Grid>
            </Collapse>
          </Box>
        )}
      </CardContent>
    </Card>
  );
};

export default ConnectionStatus;
